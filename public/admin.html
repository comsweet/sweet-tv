<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Sweet TV</title>
  <style>
    body{background:#0f172a;color:#e2e8f0;font-family:Inter,system-ui,sans-serif;margin:0;padding:20px}
    h1{margin:0 0 8px} h2{margin:0 0 8px;color:#93c5fd}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .card{background:#1e293b;border-radius:10px;padding:20px;box-shadow:0 0 10px rgba(0,0,0,.3)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #334155} th{text-align:left;color:#94a3b8}
    .small{font-size:12px;opacity:.8}
    select,button{background:#334155;border:none;color:#fff;padding:6px 10px;border-radius:6px;font-size:14px;margin-right:6px}
    .stats{display:flex;gap:20px;margin-top:10px}
    .stat-box{background:#0f172a;padding:16px 22px;border-radius:10px;flex:1;text-align:center;border:1px solid #334155}
    .stat-value{font-size:26px;font-weight:700;color:#f8fafc}
    .field-ids{font-size:16px;margin-top:6px;color:#7dd3fc;font-family:ui-monospace,Menlo,Consolas,monospace}
    code{background:#0b1220;border:1px solid #1c2744;padding:1px 5px;border-radius:5px}
    .muted{color:#94a3b8}
    .error{color:#fca5a5}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid #1c2744}
  </style>
</head>
<body>
  <h1>⚙️ Admin – Sweet TV</h1>
  <div class="small">Proxy: <span id="proxyUrl"></span></div>

  <div class="grid">
    <div class="card">
      <h2>User groups</h2>
      <div id="groupsInfo" class="small muted">Laddar…</div>
      <table id="groupsTable">
        <thead><tr><th>Namn</th><th>ID</th><th>Agenter</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Agenter</h2>
      <div id="agentsInfo" class="small muted">Laddar…</div>
      <table id="agentsTable">
        <thead><tr><th>Namn</th><th>Grupp</th><th>Roll</th><th>E-post</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Data check – Commission & Deals</h2>
    <div class="small muted" id="sessionsHdr"></div>
    <div style="margin:8px 0 12px 0">
      <select id="period">
        <option value="today">Idag</option>
        <option value="month" selected>Denna månad</option>
      </select>
      <button id="reloadBtn">Ladda om</button>
      <span id="rowCount" style="margin-left:10px;" class="pill">0 sessions</span>
      <span id="leadCount" style="margin-left:8px;" class="pill">0 lead-hämtningar</span>
      <span style="margin-left:15px" class="small">
        Statusfilter: <b>success</b> • Tidsfilter: <code>lastUpdatedTime</code> • Fields – C:<span id="fC">70163</span>
        M:<span id="fM">74126</span> O:<span id="fO">71067</span>
      </span>
    </div>

    <div class="stats">
      <div class="stat-box">
        <div class="small">Totalt deals</div>
        <div class="stat-value" id="statDeals">0</div>
      </div>
      <div class="stat-box">
        <div class="small">Totalt Commission</div>
        <div class="stat-value" id="statCommission">0 THB</div>
      </div>
      <div class="stat-box">
        <div class="small">Unika agenter (med deals)</div>
        <div class="stat-value" id="statAgents">0</div>
      </div>
      <div class="stat-box">
        <div class="small">Fält-ID:n</div>
        <div class="field-ids">
          Commission: <b id="cid">70163</b><br>
          MultiDeals: <b id="mid">74126</b><br>
          Order date (om den används): <b id="oid">71067</b>
        </div>
      </div>
    </div>

    <h4 style="margin-top:24px;">Topplista (period)</h4>
    <table id="rankingTable">
      <thead><tr><th>#</th><th>Agent</th><th>Grupp</th><th>Deals</th><th>Commission</th></tr></thead>
      <tbody></tbody>
    </table>

    <h4 style="margin-top:18px;">Senaste affärer (15 st)</h4>
    <table id="latestTable">
      <thead><tr><th>Tid</th><th>Agent</th><th>Grupp</th><th>Commission</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="small muted" style="margin-top:10px">
      Affär = <b>session</b> där <code>status</code> = <code>success</code>.
      Tidsfiltrering görs via <code>lastUpdatedTime</code>. Commission & MultiDeals hämtas från <code>resultData</code> på lead (fallback till <code>masterData</code>).
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const API = '/api/v1';
    document.getElementById('proxyUrl').textContent = window.location.origin + API;

    // Fält-ID:n (kampanjens resultFields)
    const FIELD = { COMMISSION: 70163, MULTIDEALS: 74126, ORDERDATE: 71067 };

    const DEBUG = true;
    const dlog = (...a)=>{ if (DEBUG) console.log('[admin]', ...a); };

    // State
    const state = {
      users: [],
      groups: [],
      sessions: [],
      lastSeen: null,
      leadCache: new Map(), // leadId -> leadObj
      leadFetches: 0
    };

    // Gör peek möjligt direkt
    window.__peekSession = ()=> state.lastSeen || state.sessions?.[0] || undefined;

    // ---------- HELPERS ----------
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    function dateRange(period){
      const now=new Date();
      const start = period==='today' ? new Date(now.getFullYear(),now.getMonth(),now.getDate())
                                     : new Date(now.getFullYear(),now.getMonth(),1);
      start.setHours(0,0,0,0);
      return {from:start,to:now};
    }
    function toTHB(n){ return `${(n||0).toLocaleString('th-TH',{maximumFractionDigits:0})} THB`; }
    const nameOf = (u)=> u?.displayName || u?.name || `${u?.firstName||''} ${u?.lastName||''}`.trim() || 'Okänd';
    const groupOf= (u)=> u?.group?.name || (Array.isArray(u?.memberOf)&&u.memberOf[0]?.name) || (Array.isArray(u?.teams)&&u.teams[0]) || '-';

    // Hitta fält i lead – prioritera resultData (resultFields) och fallback till masterData
    function readLeadField(lead, id){
      const tryRead = (container)=>{
        if (!container) return undefined;
        if (Array.isArray(container)){
          const hit = container.find(f => Number(f.id) === Number(id));
          if (hit) return (hit.value ?? hit.label ?? hit.text ?? hit.data);
        }
        if (typeof container === 'object'){
          const v = container[id] ?? container[String(id)];
          if (v !== undefined) return v;
        }
        return undefined;
      };
      const rd = tryRead(lead?.resultData) ?? tryRead(lead?.data?.resultData);
      if (rd !== undefined) return rd;
      const md = tryRead(lead?.masterData) ?? tryRead(lead?.data?.masterData);
      return md;
    }

    // ---------- USERS & GROUPS ----------
    async function loadUsersAndGroups(){
      const gInfo = document.getElementById('groupsInfo');
      const aInfo = document.getElementById('agentsInfo');
      try{
        dlog('loadUsersAndGroups:start');
        const [uRes,gRes] = await Promise.all([ fetch(`${API}/users`), fetch(`${API}/groups`) ]);
        const [users, groups] = await Promise.all([uRes.json(), gRes.json()]);
        state.users = Array.isArray(users) ? users : [];
        state.groups= Array.isArray(groups)? groups: [];
        gInfo.textContent = `${state.groups.length} grupper`;
        aInfo.textContent = `${state.users.length} agenter`;
        renderUsersAndGroups();
        dlog('loadUsersAndGroups:done', {users:state.users.length, groups:state.groups.length});
      }catch(e){
        console.error(e);
        gInfo.innerHTML = `<span class="error">Fel: kunde inte ladda grupper (${e.message})</span>`;
        aInfo.innerHTML = `<span class="error">Fel: kunde inte ladda agenter (${e.message})</span>`;
      }
    }

    function renderUsersAndGroups(){
      const gT = document.querySelector('#groupsTable tbody');
      const aT = document.querySelector('#agentsTable tbody');
      gT.innerHTML=''; aT.innerHTML='';

      state.groups.forEach(g=>{
        const tr=document.createElement('tr');
        const count=state.users.filter(u=>u.group?.id===g.id).length;
        tr.innerHTML=`<td>${g.name}</td><td>${g.id}</td><td>${count} st</td>`;
        gT.appendChild(tr);
      });

      state.users.forEach(u=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${nameOf(u)}</td><td>${groupOf(u)}</td><td>${u?.role?.name||'-'}</td><td>${u?.email||'-'}</td><td>${u?.active?'Aktiv':'Inaktiv'}</td>`;
        aT.appendChild(tr);
      });
    }

    // ---------- SESSIONS (status success, filter på lastUpdatedTime) ----------
    async function loadSessions(period){
      dlog('loadSessions:start', period);
      const { from, to } = dateRange(period);
      document.getElementById('sessionsHdr').textContent =
        `Period: ${from.toLocaleString('sv-SE')} — ${to.toLocaleString('sv-SE')}`;

      const filters = {
        lastUpdatedTime: { "$gt": from.toISOString(), "$lt": to.toISOString() },
        status: { "$eq": "success" }
      };
      const filtersParam = encodeURIComponent(JSON.stringify(filters));

      const pageSize=50, maxPages=20, maxRetries=6, baseDelay=1200;
      const all=[];

      for (let page=1; page<=maxPages; page++){
        const url = `${API}/sessions?filters=${filtersParam}`
          + `&page=${page}&pageSize=${pageSize}`
          + `&includeMeta=true`
          + `&sortProperty=lastUpdatedTime&sortDirection=DESC`;

        let tries=0;
        while (true){
          tries++;
          dlog(`→ sessions page ${page} try ${tries}`);
          const res = await fetch(url);
          if (res.status===429){
            if (tries>maxRetries) throw new Error(`Sessions 429 efter ${tries} försök p${page}`);
            const wait=baseDelay*tries; dlog(`429, backoff ${wait}ms`); await sleep(wait); continue;
          }
          if (!res.ok){
            const t=await res.text().catch(()=>res.statusText);
            throw new Error(`Sessions ${res.status} ${t}`);
          }
          const data = await res.json().catch(()=>({}));
          const list = Array.isArray(data) ? data
                      : (data.sessions||data.items||data.data||data.results||[]);
          dlog(`sessions page ${page} OK – ${list.length}`);

          if (list[0]) state.lastSeen = list[0]; // peek direkt
          all.push(...list);

          await sleep(200);
          if (list.length<pageSize) page=maxPages+1;
          break;
        }
      }

      state.sessions = all;
      document.getElementById('rowCount').textContent = `${all.length} sessions`;
      dlog('loadSessions:done', all.length);
    }

    // ---------- LEADS (per leadId, med cache, concurrency & backoff) ----------
    async function fetchLead(leadId){
      if (!leadId) return null;
      if (state.leadCache.has(leadId)) return state.leadCache.get(leadId);

      const url = `${API}/leads/${leadId}`;
      let tries = 0;
      const maxRetries = 6;
      const baseDelay = 800;

      while (true){
        tries++;
        const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
        if (res.status===429){
          if (tries>maxRetries) throw new Error(`Leads 429 för lead ${leadId} efter ${tries} försök`);
          const wait = baseDelay * tries; dlog(`lead ${leadId} → 429 backoff ${wait}ms`);
          await sleep(wait); continue;
        }
        if (!res.ok){
          const t=await res.text().catch(()=>res.statusText);
          dlog(`lead ${leadId} → HTTP ${res.status} ${t}`);
          return null;
        }
        const data = await res.json().catch(()=>null);
        state.leadCache.set(leadId, data);
        state.leadFetches++;
        document.getElementById('leadCount').textContent = `${state.leadFetches} lead-hämtningar`;
        return data;
      }
    }

    async function hydrateDealsFromLeads(records){
      // Kör i små batchar för att hålla oss under limits
      const maxConcurrent = 4;
      let i = 0;
      async function worker(){
        while (i < records.length){
          const idx = i++;
          const rec = records[idx];
          rec.__lead = await fetchLead(rec.leadId);
        }
      }
      const workers = Array.from({length:maxConcurrent}, worker);
      await Promise.all(workers);
    }

    // ---------- AGGREGATE ----------
    async function aggregate(period){
      const usersById = new Map(state.users.map(u=>[u.id, u]));

      // Förbered rekord att hydrera
      const records = state.sessions.map(s => ({
        leadId: s.leadId,
        userId: s.userId || s?.user?.id,
        when: new Date(s.lastUpdatedTime || s.startTime || s.updatedAt || s.createdAt || Date.now())
      }));

      // Hämta Commission/MultiDeals från lead.resultData (fallback masterData)
      await hydrateDealsFromLeads(records);

      const agg = new Map();
      const last = [];

      for (const r of records){
        const u = usersById.get(r.userId);
        const name = u ? nameOf(u) : `User ${r.userId ?? '-'}`;
        const group = u ? groupOf(u) : '-';

        const lead = r.__lead;
        if (!lead) continue;

        const commission = parseFloat(readLeadField(lead, FIELD.COMMISSION)) || 0;
        if (commission <= 0) continue;

        const multiRaw = readLeadField(lead, FIELD.MULTIDEALS);
        const incDeals = Number.isFinite(parseFloat(multiRaw)) && parseFloat(multiRaw) > 0
          ? parseFloat(multiRaw)
          : 1;

        if (!agg.has(r.userId)) agg.set(r.userId, { userId:r.userId, name, group, deals:0, commission:0 });
        const a = agg.get(r.userId);
        a.deals += incDeals;
        a.commission += commission;

        last.push({ when: r.when, name, group, commission });
      }

      // Sortera & summera
      const arr = [...agg.values()].sort((a,b)=> b.deals!==a.deals ? b.deals-a.deals : b.commission-a.commission);
      const totalDeals = arr.reduce((s,x)=>s+x.deals,0);
      const totalComm  = arr.reduce((s,x)=>s+x.commission,0);

      // UI
      document.getElementById('statDeals').textContent = totalDeals;
      document.getElementById('statCommission').textContent = toTHB(totalComm);
      document.getElementById('statAgents').textContent = arr.length;

      const rT = document.querySelector('#rankingTable tbody');
      rT.innerHTML = arr.length
        ? arr.slice(0,20).map((x,i)=>`
            <tr><td>${i+1}</td><td>${x.name}</td><td>${x.group}</td><td>${x.deals}</td><td>${x.commission.toFixed(0)} THB</td></tr>
          `).join('')
        : `<tr><td colspan="5" class="small muted">Inga affärer i vald period.</td></tr>`;

      last.sort((a,b)=> (b.when?.getTime()||0)-(a.when?.getTime()||0));
      const lT = document.querySelector('#latestTable tbody');
      lT.innerHTML = last.length
        ? last.slice(0,15).map(r=>`
            <tr><td>${r.when ? r.when.toLocaleString('sv-SE') : '-'}</td><td>${r.name}</td><td>${r.group}</td><td>${r.commission.toFixed(0)} THB</td></tr>
          `).join('')
        : `<tr><td colspan="4" class="small muted">Inga affärer hittades.</td></tr>`;
    }

    // ---------- RUN ----------
    async function refresh(){
      const p = document.getElementById('period').value;
      try{
        state.leadCache.clear();
        state.leadFetches = 0;
        document.getElementById('leadCount').textContent = `0 lead-hämtningar`;
        await loadSessions(p);     // hämtar sidvis och exponerar peek direkt
        await aggregate(p);
      }catch(e){
        console.error(e);
        document.getElementById('rowCount').textContent = 'error';
      }
    }

    document.getElementById('reloadBtn').addEventListener('click', refresh);
    (async()=>{ await loadUsersAndGroups(); await refresh(); })();
  </script>
</body>
</html>
