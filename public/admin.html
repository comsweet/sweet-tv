<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Admin ‚Äì Sweet TV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0f1727; --panel:#111b2e; --muted:#9aa4b2; --text:#d9e1ee; --accent:#4cc9f0; }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .bar{ display:flex; gap:16px; align-items:center; border-bottom:1px solid rgba(255,255,255,.06); padding:12px 16px; }
    .grid{ display:grid; grid-template-columns: 420px 1fr; gap:16px; padding:16px; }
    .card{ background:var(--panel); border-radius:12px; padding:12px; }
    .title{ font-weight:700; margin-bottom:8px; }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    th, td{ padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06); }
    th{ color:var(--muted); text-align:left; font-weight:600; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    select, input, button{
      background:#0e1625; border:1px solid rgba(255,255,255,.12); color:#fff; border-radius:8px; padding:6px 10px;
    }
    button{ cursor:pointer; background:#1b2a44; }
    .pill{ background:#0e1625; border:1px solid rgba(255,255,255,.12); border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted); }
    .error{ color:#ff9aa2; font-size:13px; margin-top:6px; }
  </style>
</head>
<body>
  <div class="bar">
    <div>üõ†Ô∏è <strong>Admin ‚Äì Sweet TV</strong></div>
    <div class="pill">Proxy: <code>/api/v1 ‚Üí Adversus</code></div>
    <div class="pill">Leaderboard: <code>/api/leaderboard</code></div>
    <div id="barError" class="error" style="margin-left:auto"></div>
  </div>

  <div class="grid">
    <!-- V√§nster: Users -->
    <div class="card">
      <div class="title">User groups & agenter</div>
      <div id="usersError" class="error"></div>
      <div style="max-height:420px; overflow:auto">
        <table>
          <thead><tr><th>Namn</th><th>Grupp</th><th>Roll</th><th>E-post</th><th>Status</th></tr></thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>
    </div>

    <!-- H√∂ger: Data check / Preview -->
    <div class="card">
      <div class="title">Data check ‚Äì Commission & Deals (preview)</div>

      <div class="row">
        <label>Period:</label>
        <select id="period">
          <option value="month">Denna m√•nad</option>
          <option value="today">Idag</option>
        </select>

        <label>Sortera p√•:</label>
        <select id="metric">
          <option value="deals">Aff√§rer</option>
          <option value="commission">Commission</option>
        </select>

        <label>Topp:</label>
        <select id="size">
          <option>10</option><option>25</option><option>50</option>
        </select>

        <label>Grupper:</label>
        <input id="groups" placeholder="t.ex. Dentle Faraz,Sinfrid Bangkok" style="min-width:260px" />

        <button id="reload">Ladda om</button>
      </div>

      <div class="row">
        <span class="pill" id="count">Leads: 0</span>
        <span class="pill">F√§lt-ID:n <span id="fieldIds">C: 70163  M:74126  O:71067</span></span>
      </div>

      <div id="lbError" class="error"></div>

      <div style="max-height:520px; overflow:auto; margin-top:6px">
        <table id="agentsTable">
          <thead>
            <tr>
              <th style="width:56px">#</th>
              <th>Agent</th>
              <th>Grupp</th>
              <th>Deals</th>
              <th>Commission</th>
            </tr>
          </thead>
          <tbody id="lbBody"></tbody>
        </table>
      </div>

      <div style="margin-top:12px">
        <div class="title" style="font-size:14px; color:var(--muted)">Senaste aff√§rer (15 st)</div>
        <table>
          <thead>
            <tr>
              <th>Tid</th><th>Agent</th><th>Grupp</th><th>Commission</th>
            </tr>
          </thead>
          <tbody id="latestBody"></tbody>
        </table>
        <div class="pill" style="margin-top:8px">
          Filtrering g√∂rs p√• <code>lastUpdatedTime</code>. Visningstid = <code>Order date</code> om den finns, annars <code>lead.lastUpdatedTime</code>.
          Commission & MultiDeals l√§ses fr√•n <code>lead.resultData</code> (fallback <code>masterData</code>).
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiLB = '/api/leaderboard';
    const apiUsers = '/api/v1/users';

    const $usersBody = document.getElementById('usersBody');
    const $usersError = document.getElementById('usersError');
    const $barError = document.getElementById('barError');

    const $period = document.getElementById('period');
    const $metric = document.getElementById('metric');
    const $size = document.getElementById('size');
    const $groups = document.getElementById('groups');
    const $reload = document.getElementById('reload');

    const $lbBody = document.getElementById('lbBody');
    const $lbError = document.getElementById('lbError');
    const $count = document.getElementById('count');
    const $latestBody = document.getElementById('latestBody');

    function fmtTHB(n){ return new Intl.NumberFormat('sv-SE').format(Math.round(n)) + ' THB'; }

    async function loadUsers(){
      $usersError.textContent = '';
      $usersBody.innerHTML = '';
      try{
        const resp = await fetch(apiUsers);
        if(!resp.ok) throw new Error(`Users ${resp.status}`);
        const data = await resp.json();
        const rows = Array.isArray(data) ? data : (data?.users || []);
        $usersBody.innerHTML = rows.map(u => `
          <tr>
            <td>${u.name || u.displayName || '-'}</td>
            <td>${u.group?.name || (u.memberOf?.[0]?.name) || '-'}</td>
            <td>${u.role?.name || '-'}</td>
            <td>${u.email || '-'}</td>
            <td>${u.active ? 'Aktiv' : 'Inaktiv'}</td>
          </tr>
        `).join('');
      }catch(err){
        console.error(err);
        $usersError.textContent = 'Fel: ' + (err.message || err);
      }
    }

    function parseGroups(){
      return $groups.value.split(',').map(s=>s.trim()).filter(Boolean).join(',');
    }

    async function loadLeaderboard(){
      $lbError.textContent = '';
      $lbBody.innerHTML = '';
      $latestBody.innerHTML = '';
      $count.textContent = 'Leads: ‚Ä¶';

      const qs = new URLSearchParams({
        period: $period.value,
        metric: $metric.value,
        size: $size.value,
      });
      const g = parseGroups();
      if(g) qs.set('groups', g);

      try{
        const resp = await fetch(`${apiLB}?${qs.toString()}`);
        if(!resp.ok){
          const t = await resp.text();
          throw new Error(`Leaderboard ${resp.status}: ${t}`);
        }
        const data = await resp.json();
        if(!data.ok) throw new Error(data.details || 'Ok√§nt svar');

        $count.textContent = `Topp ${data.size} | Agenter (med deals): ${data.totalAgents}`;

        // Topp-lista
        $lbBody.innerHTML = data.data.map((r,i)=>`
          <tr>
            <td>#${i+1}</td>
            <td>${r.name}</td>
            <td>${r.group || '-'}</td>
            <td>${r.deals}</td>
            <td>${fmtTHB(r.commission)}</td>
          </tr>
        `).join('');

        // (Valfritt) ‚ÄúSenaste aff√§rer‚Äù ‚Äì h√§r visar vi bara toppens rader som mockad ‚Äúsenaste‚Äù
        // Du kan byta till en egen /api/senaste om du vill f√• exakt tidslista.
        $latestBody.innerHTML = data.data.slice(0, 15).map(r => `
          <tr>
            <td>${new Date().toISOString().slice(0,19).replace('T',' ')}</td>
            <td>${r.name}</td>
            <td>${r.group || '-'}</td>
            <td>${fmtTHB(r.commission)}</td>
          </tr>
        `).join('');
      }catch(err){
        console.error(err);
        $lbError.textContent = 'Fel: ' + (err.message || err);
      }
    }

    $reload.onclick = loadLeaderboard;
    $period.onchange = loadLeaderboard;
    $metric.onchange = loadLeaderboard;
    $size.onchange = loadLeaderboard;

    // init
    loadUsers();
    loadLeaderboard();
  </script>
</body>
</html>
