<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€“ Sweet TV</title>
  <style>
    :root { --bg:#0f1727; --card:#121c2e; --ink:#e5eeff; --mut:#9fb0c7; --pill:#20324f; --accent:#87a6ff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .bar{display:flex;gap:12px;align-items:center;padding:10px 16px;color:var(--mut)}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px}
    .card{background:var(--card);border-radius:12px;padding:14px 16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    h3{margin:0 0 10px;font-size:15px;color:#cfe0ff;letter-spacing:.3px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1c2a45}
    th{font-weight:600;text-align:left;color:#cde}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{background:var(--pill);padding:6px 10px;border-radius:999px;color:#cfe}
    input,select,button{background:#101a2b;color:var(--ink);border:1px solid #213354;border-radius:8px;padding:8px 10px}
    button{cursor:pointer}
    .mut{color:var(--mut)}
    .right{display:flex;gap:8px;align-items:center}
    .num{font-feature-settings:"tnum";font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <div class="bar">
    <div>ðŸ‘‘ Admin â€“ Sweet TV</div>
    <div class="mut">Proxy: <span class="pill">/api/v1 â†’ Adversus</span></div>
    <div class="mut">Leaderboard: <span class="pill">/api/leaderboard</span></div>
    <div id="err" class="mut"></div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>User groups &amp; agenter</h3>
      <div id="usersErr" class="mut"></div>
      <div style="max-height:420px;overflow:auto">
        <table id="usersTbl">
          <thead><tr><th>Namn</th><th>Grupp</th><th>Roll</th><th>E-post</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>Data check â€“ Commission &amp; Deals (preview)</h3>

      <div class="row" style="margin-bottom:10px">
        <label>Period:</label>
        <select id="period">
          <option value="month">Denna mÃ¥nad</option>
          <option value="today">Idag</option>
        </select>

        <label>Sortera pÃ¥:</label>
        <select id="metric">
          <option value="deals">AffÃ¤rer</option>
          <option value="commission">Commission</option>
        </select>

        <label>Topp:</label>
        <select id="size">
          <option>10</option><option>20</option><option>50</option>
        </select>

        <div class="right">
          <input id="groupFilter" placeholder="t.ex. Dentle Faraz,Sinfrid Bangkok" style="min-width:320px" />
          <button id="reload">Ladda om</button>
        </div>
      </div>

      <div class="row" style="margin-bottom:10px;gap:16px">
        <div class="pill">Totalt deals <span id="totDeals" class="num">0</span></div>
        <div class="pill">Totalt Commission <span id="totComm" class="num">0 THB</span></div>
        <div class="pill">Unika agenter (med deals) <span id="uniq" class="num">0</span></div>
        <div class="pill">FÃ¤lt-ID:n<br/>C:<span id="fidC"></span> M:<span id="fidM"></span> O:<span id="fidO"></span></div>
      </div>

      <div class="mut" id="meta"></div>

      <div style="display:grid;grid-template-columns:1fr;gap:16px;margin-top:10px">
        <div class="card" style="background:#0f192a">
          <div class="row" style="justify-content:space-between">
            <div class="mut">Fel: <span id="lbErr">â€“</span></div>
            <div class="mut">Leads: <span id="leadCount" class="num">0</span></div>
          </div>
          <table id="topTbl">
            <thead><tr><th>#</th><th>Agent</th><th>Grupp</th><th>Deals</th><th>Commission</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" style="background:#0f192a">
          <h3>Senaste affÃ¤rer (15 st)</h3>
          <table id="recentTbl">
            <thead><tr><th>Tid</th><th>Agent</th><th>Grupp</th><th>Commission</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
const API = location.origin + '/api';

async function loadUsers() {
  try {
    const r = await fetch(API + '/v1/users');
    if (!r.ok) throw new Error(r.status);
    const users = await r.json();
    const tb = document.querySelector('#usersTbl tbody');
    tb.innerHTML = '';
    (Array.isArray(users) ? users : []).forEach(u => {
      const g = (u.group && u.group.name) || (u.memberOf && u.memberOf[0]?.name) || '';
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${u.displayName || u.name}</td>
         <td class="mut">${g||'-'}</td>
         <td class="mut">${u.role?.name || '-'}</td>
         <td class="mut">${u.email || '-'}</td>
         <td class="mut">${u.active ? 'Aktiv' : 'Inaktiv'}</td>`;
      tb.appendChild(tr);
    });
    document.getElementById('usersErr').textContent = '';
  } catch (e) {
    document.getElementById('usersErr').textContent = 'Fel: ' + e.message;
  }
}

function num(x){ return Number(x||0).toLocaleString('sv-SE'); }

async function loadLeaderboard() {
  const period = document.getElementById('period').value;
  const metric = document.getElementById('metric').value;
  const size = document.getElementById('size').value;
  const groups = document.getElementById('groupFilter').value.trim();

  const url = new URL(API + '/leaderboard');
  url.searchParams.set('period', period);
  url.searchParams.set('metric', metric);
  url.searchParams.set('size', size);
  url.searchParams.set('includeRecent','true');
  if (groups) url.searchParams.set('groups', groups);

  const r = await fetch(url);
  const tb = document.querySelector('#topTbl tbody');
  const rb = document.querySelector('#recentTbl tbody');
  tb.innerHTML = ''; rb.innerHTML = '';

  if (!r.ok) {
    document.getElementById('lbErr').textContent = r.status + ' (server)';
    return;
  }
  const data = await r.json();
  document.getElementById('lbErr').textContent = 'â€“';
  document.getElementById('leadCount').textContent = num(data.meta?.leads || 0);
  document.getElementById('fidC').textContent = data.meta?.fields?.commission || '';
  document.getElementById('fidM').textContent = data.meta?.fields?.multideals || '';
  document.getElementById('fidO').textContent = data.meta?.fields?.orderDate || '';
  document.getElementById('meta').textContent =
    `KÃ¤lla: /api/leaderboard (status="success", tidsfilter ${data.meta?.period?.from} â†’ ${data.meta?.period?.to}).`;

  let totDeals = 0, totComm = 0, uniq = 0;
  (data.top || []).forEach((row, i) => {
    totDeals += row.deals; totComm += row.commission; uniq++;
    const tr = document.createElement('tr');
    tr.innerHTML =
      `<td class="num">${i+1}</td>
       <td>${row.name}</td>
       <td class="mut">${row.group || '-'}</td>
       <td class="num">${num(row.deals)}</td>
       <td class="num">${num(row.commission)} THB</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('totDeals').textContent = num(totDeals);
  document.getElementById('totComm').textContent = num(totComm) + ' THB';
  document.getElementById('uniq').textContent = num(uniq);

  (data.recent || []).forEach(rw => {
    const tr = document.createElement('tr');
    const t = new Date(rw.time);
    tr.innerHTML =
      `<td class="num">${t.toISOString().replace('T',' ').slice(0,19)}</td>
       <td>${rw.agent}</td>
       <td class="mut">${rw.group || '-'}</td>
       <td class="num">${num(rw.commission)} THB</td>`;
    rb.appendChild(tr);
  });
}

document.getElementById('reload').addEventListener('click', loadLeaderboard);
loadUsers().then(loadLeaderboard);
</script>
</body>
</html>
