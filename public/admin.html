<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Sweet TV</title>
  <style>
    body {
      background-color: #0f172a;
      color: #e2e8f0;
      font-family: "Inter", sans-serif;
      margin: 0;
      padding: 20px;
    }

    h2 {
      margin-bottom: 8px;
      color: #93c5fd;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background-color: #1e293b;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #334155;
    }

    th {
      color: #94a3b8;
      text-align: left;
    }

    .small {
      font-size: 12px;
      opacity: 0.7;
    }

    select, button {
      background-color: #334155;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 5px;
      font-size: 14px;
      margin-right: 6px;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .stat-box {
      background-color: #1e293b;
      padding: 15px 25px;
      border-radius: 10px;
      flex: 1;
      text-align: center;
    }

    .stat-value {
      font-size: 26px;
      font-weight: bold;
      color: #f8fafc;
    }

    .field-ids {
      font-size: 16px;
      margin-top: 10px;
      color: #7dd3fc;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>⚙️ Admin – Sweet TV</h1>
  <div style="font-size: 13px; opacity: .7; margin-bottom: 10px;">
    Proxy: <span id="proxyUrl"></span>
  </div>

  <div class="grid">
    <div class="card">
      <h2>User groups</h2>
      <div id="groupsInfo">Laddar...</div>
      <table id="groupsTable">
        <thead><tr><th>Namn</th><th>ID</th><th>Agenter</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Agenter</h2>
      <div id="agentsInfo">Laddar...</div>
      <table id="agentsTable">
        <thead><tr><th>Namn</th><th>Grupp</th><th>Roll</th><th>E-post</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Data check – Commission & Deals</h2>
    <div>
      <select id="period">
        <option value="today">Idag</option>
        <option value="month" selected>Denna månad</option>
      </select>
      <button onclick="refreshDataCheck()">Ladda om</button>
      <span id="leadCount" style="margin-left: 10px;">0 leads</span>
      <span id="fieldIds" style="margin-left: 15px;" class="small">
        Fields – C:<span id="fC">70163</span> M:<span id="fM">74126</span> O:<span id="fO">71067</span>
      </span>
    </div>

    <div class="stats">
      <div class="stat-box">
        <div class="small">Totalt deals</div>
        <div class="stat-value" id="statDeals">0</div>
      </div>
      <div class="stat-box">
        <div class="small">Totalt Commission</div>
        <div class="stat-value" id="statCommission">0 THB</div>
      </div>
      <div class="stat-box">
        <div class="small">Unika agenter (med deals)</div>
        <div class="stat-value" id="statAgents">0</div>
      </div>
      <div class="stat-box">
        <div class="small">Fält-ID:n</div>
        <div class="field-ids">
          Commission: <b id="cid">70163</b><br>
          MultiDeals: <b id="mid">74126</b><br>
          Order date: <b id="oid">71067</b>
        </div>
      </div>
    </div>

    <h4 style="margin-top: 30px;">Topplista (period)</h4>
    <table id="rankingTable">
      <thead><tr><th>#</th><th>Agent</th><th>Grupp</th><th>Deals</th><th>Commission</th></tr></thead>
      <tbody></tbody>
    </table>

    <h4 style="margin-top: 20px;">Senaste affärer (15 st)</h4>
    <table id="latestTable">
      <thead><tr><th>Tid</th><th>Agent</th><th>Grupp</th><th>Commission</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="small" style="margin-top:10px;">
      Affär = lead med <code>Commission > 0</code>. MultiDeals används om angivet, annars default <code>1</code>.
      Orderfiltrering görs via fältet <code>Order date</code> (ISO-tid, UTC) om det finns, annars med API:ts from/to.
    </div>
  </div>

  <script>
    // ================= CONFIG ==================
    const API = '/api/v1';
    const FIELDS = { COMMISSION: 70163, MULTIDEALS: 74126, ORDERDATE: 71067 };
    const DEBUG = true;
    const dlog = (...a) => { if (DEBUG) console.log('[admin]', ...a); };

    document.getElementById('proxyUrl').textContent = window.location.origin + API;
    const state = { users: [], groups: [], leads: [] };

    // ========== HELPERS ==========
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    function dateRange(period) {
      const now = new Date();
      const start = period === 'today'
        ? new Date(now.getFullYear(), now.getMonth(), now.getDate())
        : new Date(now.getFullYear(), now.getMonth(), 1);
      return { from: start, to: now };
    }

    // ========== FETCH USERS & GROUPS ==========
    async function loadUsersAndGroups() {
      dlog('loadUsersAndGroups:start');
      const usersRes = await fetch(`${API}/users`);
      const groupsRes = await fetch(`${API}/groups`);
      const users = await usersRes.json();
      const groups = await groupsRes.json();
      state.users = Array.isArray(users) ? users : [];
      state.groups = Array.isArray(groups) ? groups : [];
      renderUsersAndGroups();
      dlog('loadUsersAndGroups:done', { users: state.users.length, groups: state.groups.length });
    }

    function renderUsersAndGroups() {
      const gT = document.querySelector('#groupsTable tbody');
      const aT = document.querySelector('#agentsTable tbody');
      gT.innerHTML = '';
      aT.innerHTML = '';

      state.groups.forEach(g => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${g.name}</td><td>${g.id}</td><td>${g.users?.length || 0} st</td>`;
        gT.appendChild(tr);
      });

      state.users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.name}</td>
          <td>${u.group?.name || '-'}</td>
          <td>${u.role?.name || '-'}</td>
          <td>${u.email || '-'}</td>
          <td>${u.active ? 'Aktiv' : 'Inaktiv'}</td>`;
        aT.appendChild(tr);
      });
    }

    // ========== LOAD LEADS with PAGINATION + BACKOFF ==========
    async function loadLeads(period) {
      dlog('loadLeads:start', period);
      const { from, to } = dateRange(period);
      const pageSize = 50;
      const maxPages = 10;
      const collected = [];

      for (let page = 1; page <= maxPages; page++) {
        const url = `${API}/leads?from=${encodeURIComponent(from.toISOString())}&to=${encodeURIComponent(to.toISOString())}&page=${page}&pageSize=${pageSize}&includeMeta=true&sortProperty=updated&sortDirection=DESC`;
        let tries = 0;
        while (true) {
          tries++;
          dlog(`→ Page ${page} try ${tries}`);
          const res = await fetch(url);
          if (res.status === 429) {
            if (tries > 5) throw new Error(`Leads 429 efter 5 försök på page ${page}`);
            const delay = 1000 * tries;
            dlog(`429 Too Many Requests. Väntar ${delay} ms...`);
            await sleep(delay);
            continue;
          }
          if (res.status >= 500) throw new Error(`Leads ${res.status}`);
          const data = await res.json();
          const leads = Array.isArray(data) ? data : (data.items || data.leads || []);
          dlog(`Page ${page} OK – ${leads.length} leads`);
          collected.push(...leads);
          await sleep(250);
          if (leads.length < pageSize) page = maxPages + 1;
          break;
        }
      }
      state.leads = collected;
      document.getElementById('leadCount').textContent = `${state.leads.length} leads`;
      dlog('loadLeads:done', collected.length);
    }

    // ========== AGGREGATE ==========
    function aggregate(period) {
      const cField = FIELDS.COMMISSION, mField = FIELDS.MULTIDEALS, oField = FIELDS.ORDERDATE;
      const users = new Map();

      let totalDeals = 0, totalComm = 0;

      state.leads.forEach(lead => {
        const userId = lead.lastContactedBy || lead.lastUpdatedBy;
        if (!userId) return;

        let commission = 0, deals = 0;
        let orderDate = null;

        const allFields = [
          ...(lead.resultFields || []),
          ...(lead.masterData || [])
        ];

        for (const f of allFields) {
          if (f.id == cField) commission = parseFloat(f.value) || 0;
          if (f.id == mField) deals = parseFloat(f.value) || 1;
          if (f.id == oField) orderDate = f.value;
        }

        if (commission > 0) {
          totalComm += commission;
          totalDeals += deals;

          const existing = users.get(userId) || { id: userId, deals: 0, commission: 0 };
          existing.deals += deals;
          existing.commission += commission;
          users.set(userId, existing);
        }
      });

      // Render statistik
      document.getElementById('statDeals').textContent = totalDeals;
      document.getElementById('statCommission').textContent = `${totalComm.toLocaleString()} THB`;
      document.getElementById('statAgents').textContent = users.size;

      const leaderboard = Array.from(users.values()).sort((a,b)=>b.commission - a.commission);
      const tbody = document.querySelector('#rankingTable tbody');
      tbody.innerHTML = leaderboard.slice(0,15).map((u,i)=>{
        const user = state.users.find(x=>x.id==u.id);
        return `<tr><td>${i+1}</td><td>${user?.name||u.id}</td><td>${user?.group?.name||'-'}</td><td>${u.deals}</td><td>${u.commission.toFixed(0)} THB</td></tr>`;
      }).join('');
    }

    // ========== DATA CHECK RUN ==========
    async function refreshDataCheck() {
      const period = document.querySelector('#period').value;
      dlog('refreshDataCheck:start', { period });
      try {
        await loadLeads(period);
        dlog('refreshDataCheck:leads_loaded', { count: state.leads.length });
        aggregate(period);
        dlog('refreshDataCheck:aggregated');
      } catch (e) {
        console.error('refreshDataCheck:ERROR', e);
        const lc = document.querySelector('#leadCount');
        if (lc) lc.textContent = `error`;
      }
    }

    // ========== DEBUG TOOLS ==========
    window.__peek = function() {
      const first = state.leads?.[0];
      if (!first) return dlog('__peek: no leads loaded');
      dlog('__peek:first-lead', first);
    };

    // ========== INIT ==========
    (async () => {
      await loadUsersAndGroups();
      await refreshDataCheck();
    })();
  </script>
</body>
</html>
