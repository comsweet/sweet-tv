<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Äì Sweet TV</title>
  <style>
    :root{--bg:#0f1522;--card:#141c2e;--muted:#9fb0ce}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#fff;font:16px/1.4 system-ui,Segoe UI,Roboto}
    header{padding:18px 24px;border-bottom:1px solid #26324b;display:flex;gap:16px;align-items:center}
    header h1{font-size:20px;margin:0} header a{color:var(--muted);text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:24px;display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .card{background:var(--card);border:1px solid #26324b;border-radius:14px;padding:16px}
    .card h2{margin:0 0 12px 0;font-size:18px}
    .toolbar{display:flex;gap:10px;margin-bottom:12px}
    input[type="search"]{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #2d3a57;background:#0d1320;color:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid #223052} th{font-weight:600;color:var(--muted);text-align:left}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#1b2741;color:#dbe8ff;border:1px solid #2a3a5f}
    .muted{color:var(--muted)} .small{font-size:12px}
    .badge{background:#102a3a;color:#9fe8ff;border:1px solid #1c4152;padding:2px 8px;border-radius:999px;font-size:12px}
    .hint{color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <header>
    <h1>Admin ‚Äì Sweet TV</h1>
    <a href="/" title="Till TV-vyn">üè† TV</a>
    <span class="hint small" id="envHint"></span>
  </header>

  <div class="wrap">
    <!-- USER GROUPS -->
    <section class="card">
      <h2>User groups</h2>
      <div class="toolbar">
        <input id="groupSearch" type="search" placeholder="S√∂k grupp‚Ä¶" />
        <span class="badge" id="groupCount">0 grupper</span>
      </div>
      <table id="groupsTbl">
        <thead><tr><th>Namn</th><th>ID</th><th>Agenter</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hint small">K√§lla: <code>/api/v1/groups</code> (mappas ihop med <code>/api/v1/users</code> via <code>user.group.id</code>).</div>
    </section>

    <!-- AGENTS -->
    <section class="card">
      <h2>Agenter</h2>
      <div class="toolbar">
        <input id="agentSearch" type="search" placeholder="S√∂k agent, e-post eller grupp‚Ä¶" />
        <span class="badge" id="agentCount">0 agenter</span>
      </div>
      <table id="agentsTbl">
        <thead><tr><th>Namn</th><th>Grupp</th><th>Roll</th><th class="muted">E-post</th><th class="muted">Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <script>
    const API = `${location.origin}/api/v1`;
    document.getElementById('envHint').textContent = `Proxy: ${API}`;

    const state = { users: [], groupsApi: [], groups: new Map() };

    const Q = s => document.querySelector(s);
    const groupsBody = Q('#groupsTbl tbody');
    const agentsBody = Q('#agentsTbl tbody');
    const groupCount = Q('#groupCount');
    const agentCount = Q('#agentCount');
    const norm = s => String(s||'').toLowerCase();

    function normalizeList(payload){
      // Hantera b√•de rena arrayer och "wrapped" svar som { groups: [] }, { users: [] }, { items: [] }, etc.
      if (Array.isArray(payload)) return payload;
      if (!payload || typeof payload!=='object') return [];
      return payload.groups || payload.users || payload.items || payload.data || payload.results || [];
    }

    function renderGroups(filter=''){
      const f=norm(filter);
      const list=[...state.groups.values()].sort((a,b)=>a.name.localeCompare(b.name,'sv'));
      const rows=[];
      for (const g of list){
        if (f && !norm(g.name).includes(f) && !String(g.id).includes(f)) continue;
        rows.push(`<tr>
          <td>${g.name}</td>
          <td class="muted">${g.id}</td>
          <td><span class="pill">${g.agents.length} st</span></td>
        </tr>`);
      }
      groupsBody.innerHTML = rows.join('') || `<tr><td colspan="3" class="muted">Inga grupper matchar.</td></tr>`;
      groupCount.textContent = `${list.length} grupper`;
    }

    function renderAgents(filter=''){
      const f=norm(filter);
      const agents = state.users.map(u=>({
        name: u.displayName || u.name || `${u.firstName||''} ${u.lastName||''}`.trim() || 'Ok√§nd',
        email: u.email || '',
        group: (u?.group?.name) ||
               (Array.isArray(u?.memberOf) && u.memberOf[0]?.name) ||
               (Array.isArray(u?.teams) && u.teams[0]) || '(ingen)',
        role: u?.role?.name || '',
        active: !!u?.active
      })).sort((a,b)=>a.name.localeCompare(b.name,'sv'));

      const rows=[]; let count=0;
      for (const a of agents){
        const hay=norm(`${a.name} ${a.email} ${a.group} ${a.role}`);
        if (f && !hay.includes(f)) continue;
        count++;
        rows.push(`<tr>
          <td>${a.name}</td>
          <td>${a.group}</td>
          <td>${a.role||'<span class="muted">‚Äì</span>'}</td>
          <td class="muted">${a.email||'‚Äì'}</td>
          <td class="muted">${a.active?'Aktiv':'Inaktiv'}</td>
        </tr>`);
      }
      agentsBody.innerHTML = rows.join('') || `<tr><td colspan="5" class="muted">Inga agenter matchar.</td></tr>`;
      agentCount.textContent = `${count} agenter`;
    }

    async function loadUsersAndGroups(){
      const [usersRes, groupsRes] = await Promise.all([
        fetch(`${API}/users`),
        fetch(`${API}/groups`)
      ]);

      const usersRaw  = await usersRes.json().catch(()=>({}));
      const groupsRaw = await groupsRes.json().catch(()=>({}));

      if (!usersRes.ok)  throw new Error(`Users ${usersRes.status} ${JSON.stringify(usersRaw)}`);
      if (!groupsRes.ok) throw new Error(`Groups ${groupsRes.status} ${JSON.stringify(groupsRaw)}`);

      state.users    = normalizeList(usersRaw);   // array av users
      state.groupsApi= normalizeList(groupsRaw);  // array av grupper

      // Bygg riktig "grupp -> agenter"-mappning
      state.groups = new Map();
      for (const g of state.groupsApi) {
        state.groups.set(String(g.id), { id:g.id, name:g.name||'(namnl√∂s)', agents:[] });
      }
      for (const u of state.users) {
        const gid = u?.group?.id;
        if (gid != null) {
          const key = String(gid);
          if (!state.groups.has(key)) state.groups.set(key, { id: gid, name: u.group.name || '(namnl√∂s)', agents: [] });
          state.groups.get(key).agents.push(u);
        } else {
          // fallback ‚Äì pseudo-grupper baserat p√• memberOf/teams
          const m = Array.isArray(u?.memberOf) && u.memberOf[0] ? u.memberOf[0] : null;
          const pseudo = m ? { id:`mo:${m.id}`, name:m.name }
                           : (Array.isArray(u?.teams)&&u.teams[0] ? { id:`t:${u.teams[0]}`, name:u.teams[0] } : null);
          if (pseudo){
            const k = String(pseudo.id);
            if (!state.groups.has(k)) state.groups.set(k, { id:pseudo.id, name:pseudo.name, agents:[] });
            state.groups.get(k).agents.push(u);
          }
        }
      }

      renderGroups();
      renderAgents();
    }

    Q('#groupSearch').addEventListener('input', e=>renderGroups(e.target.value));
    Q('#agentSearch').addEventListener('input', e=>renderAgents(e.target.value));

    loadUsersAndGroups().catch(err=>{
      groupsBody.innerHTML = `<tr><td colspan="3" class="muted">Fel: ${err.message}</td></tr>`;
      agentsBody.innerHTML = `<tr><td colspan="5" class="muted">Fel: ${err.message}</td></tr>`;
    });
  </script>
</body>
</html>

