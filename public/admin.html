<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin – Sweet TV</title>
<style>
body {
  background: #0f1727;
  color: #e4e9f0;
  font-family: 'Inter', sans-serif;
  padding: 10px 20px;
}
h1 {
  font-size: 22px;
  color: #fff;
}
.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.card {
  background: #182235;
  border-radius: 8px;
  padding: 10px 20px;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
th, td {
  border-bottom: 1px solid #283347;
  padding: 6px 8px;
  text-align: left;
}
th {
  color: #9aa7bf;
  font-weight: 600;
}
.num { text-align: right; }
.small { font-size: 12px; color: #9aa7bf; }
.statbox {
  display: flex;
  justify-content: space-around;
  margin-top: 10px;
}
.stat {
  flex: 1;
  text-align: center;
  background: #111a2c;
  margin: 4px;
  padding: 10px;
  border-radius: 8px;
}
.stat h3 { margin: 0; color: #9aa7bf; font-weight: normal; }
.stat p { margin: 4px 0 0; font-size: 18px; font-weight: bold; }
.badge {
  background: #1f2a44;
  border-radius: 20px;
  padding: 2px 8px;
  font-size: 12px;
  color: #7dd3fc;
}
</style>
</head>
<body>

<h1>⚙️ Admin – Sweet TV</h1>
<p class="small">Proxy: <a href="https://sweet-tv.onrender.com/api/v1" target="_blank">https://sweet-tv.onrender.com/api/v1</a></p>

<div class="grid">
  <div class="card">
    <h2>User groups</h2>
    <table id="tblGroups">
      <thead><tr><th>Namn</th><th>ID</th><th>Agenter</th></tr></thead>
      <tbody><tr><td colspan="3">Laddar...</td></tr></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Agenter</h2>
    <table id="tblUsers">
      <thead><tr><th>Namn</th><th>Grupp</th><th>Roll</th><th>E-post</th><th>Status</th></tr></thead>
      <tbody><tr><td colspan="5">Laddar...</td></tr></tbody>
    </table>
  </div>
</div>

<div class="card" style="margin-top:20px;">
  <h2>Data check – Commission & Deals</h2>
  <div>
    <select id="selPeriod">
      <option value="month">Denna månad</option>
      <option value="today">Idag</option>
    </select>
    <button onclick="refreshDataCheck()">Ladda om</button>
    <span class="badge" id="rowCount">0 sessions</span>
    <span class="badge" id="fieldInfo">Fields – C:70163 M:74126 O:71067 R:70112 (Affär)</span>
  </div>

  <div class="statbox">
    <div class="stat"><h3>Totalt deals</h3><p id="statDeals">0</p></div>
    <div class="stat"><h3>Totalt Commission</h3><p id="statComm">0 THB</p></div>
    <div class="stat"><h3>Unika agenter (med deals)</h3><p id="statAgents">0</p></div>
  </div>

  <table style="margin-top:20px;" id="tblDeals">
    <thead>
      <tr><th>#</th><th>Agent</th><th>Grupp</th><th>Deals</th><th>Commission</th></tr>
    </thead>
    <tbody><tr><td colspan="5">Inga affärer i vald period.</td></tr></tbody>
  </table>

  <p class="small" style="margin-top:6px;">
    Affär = session där <b>Callend Reasons = "Affär"</b>. Commission hämtas från <b>Commission</b>, MultiDeals från <b>MultiDeals</b>.  
    Order-filter görs via fältet <b>Order date</b> (ISO-tid, UTC) om det finns, annars via sessionens tidsstämpel.
  </p>
</div>

<script>
const API = window.location.origin + '/api/v1';
const state = { users:[], groups:[], sessions:[] };
const FIELDS = { COMM:70163, MULTI:74126, ORDER:71067, REASON:70112 };

function dlog(...args){ console.log('[admin]',...args); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function dateRange(period){
  const now=new Date();
  if(period==='today'){
    const from=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    return {from,to:new Date()};
  }else{
    const from=new Date(now.getFullYear(),now.getMonth(),1);
    return {from,to:new Date()};
  }
}

/* ---------- USERS & GROUPS ---------- */
async function loadUsersAndGroups(){
  dlog('loadUsersAndGroups:start');
  const [u,g]=await Promise.all([
    fetch(`${API}/users`).then(r=>r.json()).catch(()=>[]),
    fetch(`${API}/groups`).then(r=>r.json()).catch(()=>[])
  ]);
  state.users=u||[]; state.groups=g||[];
  dlog('loadUsersAndGroups:done',state.users.length,state.groups.length);
  renderUsers(); renderGroups();
}

function renderGroups(){
  const tb=document.querySelector('#tblGroups tbody');
  if(!state.groups.length){tb.innerHTML='<tr><td colspan="3">Inga grupper</td></tr>';return;}
  tb.innerHTML=state.groups.map(g=>{
    const count=state.users.filter(u=>u.group&&u.group.id===g.id).length;
    return `<tr><td>${g.name}</td><td>${g.id}</td><td>${count}</td></tr>`;
  }).join('');
}

function renderUsers(){
  const tb=document.querySelector('#tblUsers tbody');
  if(!state.users.length){tb.innerHTML='<tr><td colspan="5">Inga användare</td></tr>';return;}
  tb.innerHTML=state.users.map(u=>`
    <tr>
      <td>${u.name||'-'}</td>
      <td>${u.group?u.group.name:'–'}</td>
      <td>${u.role?u.role.name:'–'}</td>
      <td>${u.email||''}</td>
      <td>${u.active?'Aktiv':'Inaktiv'}</td>
    </tr>
  `).join('');
}

/* ---------- SESSIONS LOAD (daterange via filters) ---------- */
async function loadSessions(period){
  dlog('loadSessions:start', period);
  const { from, to } = dateRange(period);
  const filters = { startTime: { "$gte": from.toISOString(), "$lt": to.toISOString() } };
  const filtersParam = encodeURIComponent(JSON.stringify(filters));
  const pageSize=50, maxPages=20, maxRetries=6, baseDelay=1200;
  const all=[];

  for(let page=1;page<=maxPages;page++){
    const url=`${API}/sessions?filters=${filtersParam}&page=${page}&pageSize=${pageSize}`
      +`&includeMeta=true&sortProperty=startTime&sortDirection=DESC`;
    let tries=0;
    while(true){
      tries++;
      dlog(`→ sessions page ${page} try ${tries}`);
      const res=await fetch(url);
      if(res.status===429){
        if(tries>maxRetries)throw new Error(`Sessions 429 efter ${tries} försök p${page}`);
        const wait=baseDelay*tries;dlog(`429, backoff ${wait}ms`);await sleep(wait);continue;
      }
      if(!res.ok){const t=await res.text().catch(()=>res.statusText);throw new Error(`Sessions ${res.status} ${t}`);}
      const data=await res.json().catch(()=>({}));
      const list=Array.isArray(data)?data:(data.items||data.data||data.results||data.sessions||[]);
      dlog(`sessions page ${page} OK – ${list.length}`);
      all.push(...list);
      await sleep(250);
      if(list.length<pageSize) page=maxPages+1;
      break;
    }
  }
  state.sessions=all;
  document.getElementById('rowCount').textContent=`${all.length} sessions`;
  dlog('loadSessions:done',all.length);
}

/* ---------- DATA CHECK ---------- */
function processData(){
  const sessions=state.sessions;
  if(!sessions.length)return { deals:[],totalDeals:0,totalComm:0 };
  const deals=[];
  for(const s of sessions){
    const rf=(s.resultData||{}).resultFields||{};
    const reason=(rf[FIELDS.REASON]||'').trim();
    if(reason!=='Affär') continue;

    const comm=parseFloat(rf[FIELDS.COMM])||0;
    const multi=parseFloat(rf[FIELDS.MULTI])||1;
    const orderDate=rf[FIELDS.ORDER]||s.startTime||'';
    const user=state.users.find(u=>u.id===s.userId)||{};
    const group=user.group?user.group.name:'–';

    deals.push({
      user:user.name||s.userName||'Okänd',
      group,comm,multi,orderDate
    });
  }

  const perUser={};
  for(const d of deals){
    if(!perUser[d.user]) perUser[d.user]={name:d.user,group:d.group,deals:0,comm:0};
    perUser[d.user].deals+=d.multi;
    perUser[d.user].comm+=d.comm;
  }
  const arr=Object.values(perUser).sort((a,b)=>b.comm-a.comm);
  return { deals:arr,totalDeals:deals.length,totalComm:arr.reduce((s,x)=>s+x.comm,0),unique:arr.length };
}

function renderData(res){
  document.getElementById('statDeals').textContent=res.totalDeals;
  document.getElementById('statComm').textContent=res.totalComm.toLocaleString('sv-SE',{maximumFractionDigits:0})+' THB';
  document.getElementById('statAgents').textContent=res.unique;
  const tb=document.querySelector('#tblDeals tbody');
  if(!res.deals.length){tb.innerHTML='<tr><td colspan="5">Inga affärer hittades.</td></tr>';return;}
  tb.innerHTML=res.deals.map((d,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${d.name}</td>
      <td>${d.group}</td>
      <td class="num">${d.deals}</td>
      <td class="num">${d.comm.toLocaleString('sv-SE',{maximumFractionDigits:0})} THB</td>
    </tr>`).join('');
}

/* ---------- MAIN REFRESH ---------- */
async function refreshDataCheck(){
  const period=document.getElementById('selPeriod').value;
  await loadSessions(period);
  const result=processData();
  renderData(result);
}

/* ---------- INIT ---------- */
async function init(){
  dlog('init:start');
  await loadUsersAndGroups();
  await refreshDataCheck();
  dlog('init:done');
}
init();
</script>

</body>
</html>
