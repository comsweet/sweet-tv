<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg1:#4f46e5; --bg2:#7c3aed; --glass:rgba(255,255,255,.12); --white:#fff; --muted:#cbd5e1; }
    * { box-sizing: border-box; }
    body {
      margin:0; min-height:100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--white); display:flex; align-items:center; justify-content:center;
      padding: 28px;
    }
    .wrap{ width: min(1200px, 100%); }
    .title { font-size:42px; font-weight:800; display:flex; gap:12px; align-items:center; }
    .sub { margin-top:6px; color:var(--muted); }
    .card { margin-top:28px; background:var(--glass); border-radius:18px; padding:18px 20px; backdrop-filter: blur(10px); }
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    select{ background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.25); color:#fff; border-radius:10px; padding:6px 10px; }
    .error{ color:#ffa8a8; margin-top:10px; }
    .list{ margin-top:16px; display:grid; gap:8px; }
    .row{ background:rgba(255,255,255,.1); border-radius:12px; padding:12px 14px; display:flex; align-items:center; }
    .rank{ width:50px; font-size:18px; font-weight:700; opacity:.9; }
    .name{ flex:1; font-size:18px; font-weight:600; }
    .group{ width:220px; color:var(--muted); }
    .stat{ width:220px; text-align:right; font-weight:700; }
    .dim{ color:var(--muted); font-weight:500; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">üèÜ Leaderboard</div>
    <div id="date" class="sub"></div>

    <div class="card">
      <div class="controls">
        <label>Period:</label>
        <select id="period">
          <option value="month">Denna m√•nad</option>
          <option value="today">Idag</option>
        </select>

        <label>Sortera p√•:</label>
        <select id="metric">
          <option value="deals">Aff√§rer (deals)</option>
          <option value="commission">Commission</option>
        </select>

        <label>Visa topp:</label>
        <select id="size">
          <option>10</option>
          <option>25</option>
          <option>50</option>
        </select>

        <span id="title" style="margin-left:auto; opacity:.9">Top 10 ‚Äì Aff√§rer (success)</span>
      </div>
      <div id="error" class="error" hidden></div>
      <div id="list" class="list"></div>
    </div>
  </div>

  <script>
    const api = location.origin + '/api/leaderboard';

    const $period = document.getElementById('period');
    const $metric = document.getElementById('metric');
    const $size = document.getElementById('size');
    const $list = document.getElementById('list');
    const $title = document.getElementById('title');
    const $error = document.getElementById('error');
    const $date = document.getElementById('date');

    function fmtTHB(n){ return new Intl.NumberFormat('sv-SE').format(Math.round(n)) + ' THB'; }
    function todayStr(){
      const now = new Date();
      $date.textContent = now.toLocaleDateString('sv-SE', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    }

    async function load(){
      $error.hidden = true; $error.textContent = '';
      $list.innerHTML = '';
      const params = new URLSearchParams({
        period: $period.value,
        metric: $metric.value,
        size: $size.value
      });
      $title.textContent = `Top ${$size.value} ‚Äì ${$metric.value === 'deals' ? 'Aff√§rer (success)' : 'Commission (success)'}`;

      try{
        const resp = await fetch(`${api}?${params.toString()}`);
        if(!resp.ok){
          const t = await resp.text();
          throw new Error(`API ${resp.status}: ${t}`);
        }
        const data = await resp.json();
        if(!data.ok) throw new Error(data.details || 'Ok√§nt svar');

        $list.innerHTML = data.data.map((r,i)=>`
          <div class="row">
            <div class="rank">#${i+1}</div>
            <div class="name">${r.name}</div>
            <div class="group">${r.group || '-'}</div>
            <div class="stat">
              ${$metric.value === 'deals'
                ? `<span>${r.deals}</span> <span class="dim">deals</span>`
                : `<span>${fmtTHB(r.commission)}</span>`}
            </div>
          </div>
        `).join('');
      }catch(err){
        console.error(err);
        $error.hidden = false;
        $error.textContent = 'Fel: ' + (err.message || err);
      }
    }

    $period.onchange = load;
    $metric.onchange = load;
    $size.onchange = load;

    todayStr();
    load();
    setInterval(todayStr, 60_000);
  </script>
</body>
</html>
