<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adversus Leaderboard Dashboard</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;overflow:hidden;height:100vh}
    .container{max-width:1400px;margin:0 auto;padding:40px;height:100vh;display:flex;flex-direction:column}
    .header{text-align:center;margin-bottom:40px;animation:fadeIn 1s ease-in}
    .header h1{font-size:56px;font-weight:bold;text-shadow:2px 2px 4px rgba(0,0,0,.3);margin-bottom:10px}
    .header .subtitle{font-size:28px;opacity:.9}
    .leaderboard{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:20px;padding:40px;box-shadow:0 8px 32px rgba(0,0,0,.3);flex:1;display:flex;flex-direction:column}
    .leaderboard-title{font-size:42px;margin-bottom:30px;text-align:center;font-weight:bold}
    .leaderboard-grid{display:flex;flex-direction:column;gap:15px;overflow-y:auto}
    .leaderboard-item{background:rgba(255,255,255,.15);padding:20px 30px;border-radius:15px;display:flex;align-items:center;transition:transform .3s ease;animation:slideIn .5s ease-out backwards}
    .leaderboard-item:hover{transform:scale(1.02)}
    .rank{font-size:36px;font-weight:bold;width:80px;text-align:center}
    .rank.top1{color:#FFD700;font-size:48px}
    .rank.top2{color:#C0C0C0;font-size:42px}
    .rank.top3{color:#CD7F32;font-size:42px}
    .user-info{flex:1;margin-left:20px}
    .user-name{font-size:32px;font-weight:600}
    .user-group{font-size:18px;opacity:.8;margin-top:5px}
    .stats-container{display:flex;flex-direction:column;align-items:flex-end;margin-right:20px}
    .deals-count{font-size:48px;font-weight:bold;line-height:1}
    .commission-value{font-size:24px;opacity:.9;margin-top:5px}
    .loading{text-align:center;font-size:32px;padding:100px}
    .error{text-align:center;color:#ff6b6b;font-size:24px;padding:50px;line-height:1.5}
    .slide-indicator{position:fixed;bottom:30px;right:30px;background:rgba(0,0,0,.5);padding:15px 25px;border-radius:30px;font-size:20px}
    .celebration{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:120px;animation:celebrate 1s ease-out;pointer-events:none;z-index:1000}
    @keyframes celebrate{0%{opacity:0;transform:translate(-50%,-50%) scale(0)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}100%{opacity:0;transform:translate(-50%,-50%) scale(1)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideIn{from{opacity:0;transform:translateX(-50px)}to{opacity:1;transform:translateX(0)}}
    .leaderboard-item:nth-child(1){animation-delay:.1s}.leaderboard-item:nth-child(2){animation-delay:.2s}.leaderboard-item:nth-child(3){animation-delay:.3s}.leaderboard-item:nth-child(4){animation-delay:.4s}.leaderboard-item:nth-child(5){animation-delay:.5s}.leaderboard-item:nth-child(6){animation-delay:.6s}.leaderboard-item:nth-child(7){animation-delay:.7s}.leaderboard-item:nth-child(8){animation-delay:.8s}.leaderboard-item:nth-child(9){animation-delay:.9s}.leaderboard-item:nth-child(10){animation-delay:1s}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèÜ Leaderboard</h1>
      <div class="subtitle" id="currentDate"></div>
    </div>
    <div class="leaderboard">
      <div class="leaderboard-title" id="leaderboardTitle">Laddar...</div>
      <div class="leaderboard-grid" id="leaderboardGrid"><div class="loading">Laddar data...</div></div>
    </div>
  </div>
  <div class="slide-indicator" id="slideIndicator">1 / 4</div>

  <script>
    // ---------- KONFIG ----------
    const CONFIG = {
      apiBase: `${location.origin}/api/v1`,
      slideInterval: 15000,
      dentleGroups: ['Dentle Faraz','Dentle Michael','Dentle Christofer','Dentle Remote'],
      sinfridGroups: ['Sinfrid Bangkok','Sinfrid Hua Hin'],
      // Om /fields ej hittas anv√§nder vi dessa default-ID:n (fr√•n din sk√§rmdump)
      defaults: { commission: 70163, multiDeals: 74126, orderDate: 71067 },
      enableSound: true,
      enableCelebration: true
    };

    let FIELD_MAP = { ...CONFIG.defaults }; // fylls fr√•n /fields vid start
    let totalDealsCount = 0, isFirstLoad = true, currentSlide = 0;

    const slides = [
      { title:'Dentle - Top 10 Denna M√•nad', type:'dentle', period:'month' },
      { title:'Dentle - Top 10 Idag',        type:'dentle', period:'today' },
      { title:'Sinfrid - Top 10 Denna M√•nad',type:'sinfrid',period:'month' },
      { title:'Sinfrid - Top 10 Idag',       type:'sinfrid',period:'today' }
    ];

    // ---------- Utils ----------
    function normalizeList(payload){
      if (Array.isArray(payload)) return payload;
      if (!payload || typeof payload!=='object') return [];
      return payload.items || payload.data || payload.results || payload.groups || payload.users || payload.leads || [];
    }
    function showCelebration(){
      if(!CONFIG.enableCelebration) return;
      const emojis=['üéâ','üéä','üèÜ','‚≠ê','üí∞','üî•','‚ú®','üéØ'];
      const el=document.createElement('div'); el.className='celebration'; el.textContent=emojis[Math.floor(Math.random()*emojis.length)];
      document.body.appendChild(el); setTimeout(()=>document.body.removeChild(el),1000);
    }
    function playPlingSound(){
      if(!CONFIG.enableSound) return;
      try{
        const ctx=new (window.AudioContext||window.webkitAudioContext)(), osc=ctx.createOscillator(), g=ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        osc.frequency.setValueAtTime(800,ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200,ctx.currentTime+.1);
        g.gain.setValueAtTime(.3,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.01,ctx.currentTime+.5);
        osc.type='sine'; osc.start(); osc.stop(ctx.currentTime+.5);
      }catch(e){console.error(e)}
    }
    function updateDate(){
      const now=new Date(); document.getElementById('currentDate').textContent = now.toLocaleDateString('sv-SE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    }
    function userBelongsToTarget(user, target){
      if (user?.group?.name && target.includes(user.group.name)) return true;
      if (Array.isArray(user?.memberOf) && user.memberOf.some(m=>target.includes(m.name))) return true;
      if (Array.isArray(user?.teams) && user.teams.some(t=>target.includes(t))) return true;
      return false;
    }
    function dateRange(period){
      const now=new Date(); let start;
      start = period==='today' ? new Date(now.getFullYear(),now.getMonth(),now.getDate())
                               : new Date(now.getFullYear(),now.getMonth(),1);
      // normalisera till 00:00 lokalt
      start.setHours(0,0,0,0);
      return { from:start, to:now };
    }
    function formatTHB(n){
      // Visa "1 234 THB" utan decimals (kan √§ndras)
      const s = (n||0).toLocaleString('th-TH',{maximumFractionDigits:0});
      return `${s} THB`;
    }

    // L√§s f√§ltv√§rden fr√•n olika st√§llen p√• leadet
    function readFieldValue(lead, fieldId){
      if (!fieldId) return undefined;
      if (lead?.customFields && lead.customFields[fieldId]!=null) return lead.customFields[fieldId];
      if (Array.isArray(lead?.masterData)){
        const hit=lead.masterData.find(x=>Number(x.id)===Number(fieldId)); if(hit) return hit.value;
      }
      if (lead?.resultFields){
        if (typeof lead.resultFields==='object' && !Array.isArray(lead.resultFields)){
          if (lead.resultFields[fieldId]!=null) return lead.resultFields[fieldId];
        } else if (Array.isArray(lead.resultFields)){
          const f=lead.resultFields.find(f=>Number(f.id)===Number(fieldId)); if(f) return f.value;
        }
      }
      return undefined;
    }

    async function loadFieldMap(){
      try{
        const res = await fetch(`${CONFIG.apiBase}/fields`);
        const raw = await res.json().catch(()=>([]));
        if (!res.ok) throw new Error(`Fields ${res.status}`);
        const arr = normalizeList(raw); // /fields verkar vara ren array ‚Äì men s√§kra √§nd√•

        const byName = (name)=> (arr.find(f=>String(f.name).toLowerCase()===name.toLowerCase())||{}).id;
        const commissionId = byName('Commission') || CONFIG.defaults.commission;
        const multiDealsId = byName('MultiDeals') || CONFIG.defaults.multiDeals;
        const orderDateId  = byName('Order date') || CONFIG.defaults.orderDate;

        FIELD_MAP = { commission: commissionId, multiDeals: multiDealsId, orderDate: orderDateId };
        console.log('[TV] Field map', FIELD_MAP);
      }catch(e){
        console.warn('[TV] /fields failed, using defaults', e);
        FIELD_MAP = { ...CONFIG.defaults };
      }
    }

    async function fetchLeadsAndUsers(period){
      // H√§mtar users och leads (utan att anta exakt paginering h√§r)
      const headers = { 'Content-Type': 'application/json' };
      const { from, to } = dateRange(period);

      // API-parametrarna kan skilja ‚Äì vi skickar from/to och filtrerar dessutom lokalt p√• orderDate
      const leadsUrl = `${CONFIG.apiBase}/leads?from=${encodeURIComponent(from.toISOString())}&to=${encodeURIComponent(to.toISOString())}`;
      const usersUrl = `${CONFIG.apiBase}/users`;

      const [leadsRes, usersRes] = await Promise.all([ fetch(leadsUrl, { headers }), fetch(usersUrl, { headers }) ]);
      const leadsRaw = await leadsRes.json().catch(()=>({}));
      const usersRaw = await usersRes.json().catch(()=>({}));
      if(!leadsRes.ok) throw new Error(`Leads ${leadsRes.status} ${JSON.stringify(leadsRaw)}`);
      if(!usersRes.ok) throw new Error(`Users ${usersRes.status} ${JSON.stringify(usersRaw)}`);

      const leads = normalizeList(leadsRaw);
      const users = normalizeList(usersRaw);
      return { leads, users, range: { from, to } };
    }

    function processLeaderboardData(payload, groupType){
      const { leads, users, range } = payload;
      const targetGroups = groupType==='dentle' ? CONFIG.dentleGroups : CONFIG.sinfridGroups;

      // bygg karta √∂ver users i r√§tt grupper
      const userMap=new Map();
      users.forEach(user=>{
        if (userBelongsToTarget(user, targetGroups)) {
          const groupName = user?.group?.name
            || (Array.isArray(user?.memberOf) && user.memberOf[0]?.name)
            || (Array.isArray(user?.teams) && user.teams[0]) || 'Ok√§nd grupp';
          userMap.set(user.id,{
            id:user.id,
            name:user.name || user.displayName || `${user.firstName||''} ${user.lastName||''}`.trim() || 'Ok√§nd',
            group:groupName, dealsCount:0, commission:0
          });
        }
      });

      let companyTotalDeals=0;
      for (const lead of leads){
        // 1) orderDate ‚Äì om finns filtrerar vi p√• perioden igen lokalt
        const orderDateRaw = readFieldValue(lead, FIELD_MAP.orderDate);
        let orderDate = null;
        if (orderDateRaw){
          const d = new Date(orderDateRaw);
          if (!isNaN(d)) orderDate = d;
        }
        if (orderDate){
          if (orderDate < range.from || orderDate > range.to) continue; // utanf√∂r period
        }

        // 2) commission (driver ‚Äúaff√§r‚Äù)
        const commission = parseFloat(readFieldValue(lead, FIELD_MAP.commission)) || 0;
        if (commission <= 0) continue; // inte en aff√§r

        // 3) multiDeals ‚Äì enligt dig alltid 1, men vi l√§ser och faller tillbaka till 1
        const md = parseFloat(readFieldValue(lead, FIELD_MAP.multiDeals));
        const dealsInc = Number.isFinite(md) && md > 0 ? md : 1;

        // 4) agentkoppling
        const userId = lead.lastContactedBy || lead.ownerId || lead.userId;
        if (userId && userMap.has(userId)){
          const u = userMap.get(userId);
          u.dealsCount += dealsInc;
          u.commission += commission;
        }

        companyTotalDeals += dealsInc;
      }

      if(!isFirstLoad && companyTotalDeals>totalDealsCount){ playPlingSound(); showCelebration(); }
      totalDealsCount=companyTotalDeals; isFirstLoad=false;

      return Array.from(userMap.values())
        .sort((a,b)=> b.dealsCount!==a.dealsCount ? b.dealsCount-a.dealsCount : b.commission-a.commission)
        .slice(0,10);
    }

    function renderLeaderboard(list,title){
      document.getElementById('leaderboardTitle').textContent=title;
      const grid=document.getElementById('leaderboardGrid');
      if(!list.length){ grid.innerHTML='<div class="loading">Ingen data tillg√§nglig f√∂r denna period</div>'; return; }
      grid.innerHTML = list.map((item,i)=>{
        const rank=i+1; let cls='', medal='';
        if(rank===1){cls='top1';medal='ü•á'} else if(rank===2){cls='top2';medal='ü•à'} else if(rank===3){cls='top3';medal='ü•â'}
        return `<div class="leaderboard-item">
          <div class="rank ${cls}">${medal} ${rank}</div>
          <div class="user-info"><div class="user-name">${item.name}</div><div class="user-group">${item.group}</div></div>
          <div class="stats-container"><div class="deals-count">${item.dealsCount} deals</div><div class="commission-value">${formatTHB(item.commission)}</div></div>
        </div>`;
      }).join('');
    }

    function showError(msg){
      document.getElementById('leaderboardGrid').innerHTML = `<div class="error">‚ö†Ô∏è ${msg}</div>`;
    }

    async function updateSlide(){
      const slide=slides[currentSlide];
      document.getElementById('slideIndicator').textContent=`${currentSlide+1} / ${slides.length}`;
      try{
        const data=await fetchLeadsAndUsers(slide.period);
        const leaderboard=processLeaderboardData(data, slide.type);
        renderLeaderboard(leaderboard, slide.title);
      }catch(e){ console.error('Update slide error', e); showError('Kunde inte ladda data. ' + e.message); }
    }
    function nextSlide(){ currentSlide=(currentSlide+1)%slides.length; updateSlide(); }

    async function init(){
      console.log('üöÄ Starting Adversus Dashboard');
      updateDate();
      await loadFieldMap();          // h√§mta f√§lt-ID:n f√∂rst
      await updateSlide();
      setInterval(nextSlide, CONFIG.slideInterval);
      setInterval(updateDate, 60000);
    }
    init();
  </script>
</body>
</html>
