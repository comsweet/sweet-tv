<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Leaderboard ‚Äì Sweet TV</title>
  <style>
    :root { --bg1:#4f46e5; --bg2:#7c3aed; --glass:rgba(255,255,255,.12); --white:#fff; --muted:rgba(255,255,255,.75); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--white);
      display:flex; align-items:center; justify-content:center;
      padding:28px;
    }
    .card{width:1100px; max-width:100%; background:var(--glass); backdrop-filter: blur(10px);
          border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,.35); padding:26px 26px 12px;}
    .header{display:flex; align-items:baseline; gap:14px; margin-bottom:14px}
    .title{font-size:44px; font-weight:800; letter-spacing:.2px}
    .date{color:var(--muted); font-size:14px}
    .toolbar{display:flex; gap:10px; align-items:center; margin:6px 0 18px}
    select{background:rgba(0,0,0,.35); color:#fff; border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:8px 10px}
    .lead{font-size:20px; font-weight:700}
    .list{margin-top:8px}
    .row{display:grid; grid-template-columns: 70px 1fr 190px 190px; gap:14px; padding:12px 10px; align-items:center;
         border-radius:12px; transition:transform .15s ease; }
    .row:nth-child(even){background:rgba(255,255,255,.06)}
    .rank{font-size:26px; font-weight:800; text-align:center}
    .name{font-size:22px; font-weight:700}
    .group{font-size:14px; color:var(--muted)}
    .stat{font-size:20px; font-weight:800; text-align:right}
    .muted{color:var(--muted)}
    .error{margin-top:10px; color:#ffb4b4}
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="title">üèÜ Leaderboard</div>
      <div class="date" id="date"></div>
    </div>

    <div class="toolbar">
      <label class="muted">Period:</label>
      <select id="period">
        <option value="month">Denna m√•nad</option>
        <option value="today">Idag</option>
      </select>

      <label class="muted" style="margin-left:10px">M√•tt:</label>
      <select id="metric">
        <option value="deals">Deals</option>
        <option value="commission">Commission</option>
      </select>

      <label class="muted" style="margin-left:10px">Grupper (kommaseparerat, valfritt):</label>
      <input id="groups" placeholder="t.ex. Dentle Faraz,Dentle Michael"
             style="flex:1; min-width:220px; background:rgba(0,0,0,.35); color:#fff; border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:8px 10px" />

      <button id="reload" style="background:#10b981; border:none; color:#fff; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer">
        Ladda om
      </button>
    </div>

    <div class="lead" id="heading">Top 10 ‚Äì Aff√§rer (success)</div>
    <div class="list" id="list"></div>
    <div class="error" id="error"></div>
  </div>

  <script>
    const dateEl = document.getElementById('date');
    const periodEl = document.getElementById('period');
    const metricEl = document.getElementById('metric');
    const groupsEl = document.getElementById('groups');
    const headingEl = document.getElementById('heading');
    const listEl = document.getElementById('list');
    const errEl = document.getElementById('error');
    const btn = document.getElementById('reload');

    const fmtDate = () => {
      const now = new Date();
      dateEl.textContent = now.toLocaleDateString('sv-SE', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    };

    async function loadLeaderboard() {
      errEl.textContent = '';
      listEl.innerHTML = '<div class="muted">Laddar‚Ä¶</div>';

      const period = periodEl.value;
      const metric = metricEl.value;
      const groups = (groupsEl.value || '').trim();

      headingEl.textContent = `Top 10 ‚Äì ${metric === 'deals' ? 'Aff√§rer' : 'Commission'} (success)`;
      const url = new URL('/api/leaderboard', window.location.origin);
      url.searchParams.set('period', period);
      url.searchParams.set('metric', metric);
      url.searchParams.set('top', '10');
      if (groups) url.searchParams.set('groups', groups);

      try {
        const r = await fetch(url.toString());
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();

        const items = Array.isArray(data.items) ? data.items : [];
        if (items.length === 0) {
          listEl.innerHTML = '<div class="muted">Inga aff√§rer i vald period.</div>';
          return;
        }

        listEl.innerHTML = items.map((x, i) => `
          <div class="row">
            <div class="rank">${i+1}</div>
            <div>
              <div class="name">${x.name}</div>
              <div class="group">${x.group || '-'}</div>
            </div>
            <div class="stat">${x.deals.toLocaleString('sv-SE')} deals</div>
            <div class="stat">${Math.round(x.commission).toLocaleString('sv-SE')} THB</div>
          </div>
        `).join('');
      } catch (e) {
        errEl.textContent = 'Fel: ' + (e?.message || e);
        listEl.innerHTML = '';
      }
    }

    btn.addEventListener('click', loadLeaderboard);
    periodEl.addEventListener('change', loadLeaderboard);
    metricEl.addEventListener('change', loadLeaderboard);

    fmtDate();
    loadLeaderboard();
    // auto-uppdatera var 30:e sekund
    setInterval(loadLeaderboard, 30000);
    setInterval(fmtDate, 60000);
  </script>
</body>
</html>
