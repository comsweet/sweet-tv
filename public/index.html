<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Leaderboard</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;height:100vh;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,#4f46e5,#7c3aed); color:#fff; font:18px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{width:1100px}
    .title{font-size:42px;font-weight:800;display:flex;align-items:center;gap:10px}
    .panel{margin-top:24px;background:rgba(255,255,255,.12);backdrop-filter:blur(8px);border-radius:16px;padding:18px 22px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.25);color:#fff;border-radius:10px;padding:6px 10px}
    table{width:100%;margin-top:14px;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.15)}
    th{font-weight:700;text-align:left;opacity:.9}
    .num{font-variant-numeric:tabular-nums}
    .msg{margin-top:10px;color:#ffdada}
    .cele{position:fixed;inset:0;display:none;align-items:center;justify-content:center;font-size:68px;pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">üèÜ Leaderboard</div>
    <div class="panel">
      <div class="row">
        <label>Period:</label>
        <select id="period"><option value="month">Denna m√•nad</option><option value="today">Idag</option></select>
        <label>Sortera p√•:</label>
        <select id="metric"><option value="deals">Aff√§rer (deals)</option><option value="commission">Commission</option></select>
        <label>Visa topp:</label>
        <select id="size"><option>10</option><option>20</option><option>50</option></select>
      </div>
      <div id="title" style="margin-top:8px;opacity:.9">Top 10 ‚Äì Aff√§rer (success)</div>
      <table id="tbl">
        <thead><tr><th>#</th><th>Agent</th><th>Grupp</th><th>Deals</th><th>Commission</th></tr></thead>
        <tbody></tbody>
      </table>
      <div id="err" class="msg"></div>
    </div>
  </div>
  <div id="cele" class="cele">üéâ</div>

<script>
const API = location.origin + '/api';
let prevTotalDeals = 0;

function num(x){ return Number(x||0).toLocaleString('sv-SE'); }
function pling(){
  try{
    const ac = new (window.AudioContext||window.webkitAudioContext)();
    const o = ac.createOscillator(); const g = ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.type='sine'; o.frequency.value=880; g.gain.value=.15;
    o.start(); setTimeout(()=>{o.stop(); ac.close()}, 250);
  }catch{}
}
function confetti(){
  const e = document.getElementById('cele'); e.style.display='flex';
  setTimeout(()=> e.style.display='none', 900);
}

async function load() {
  const period = document.getElementById('period').value;
  const metric = document.getElementById('metric').value;
  const size = document.getElementById('size').value;

  document.getElementById('title').textContent =
    `Top ${size} ‚Äì ${metric==='commission'?'Commission':'Aff√§rer'} (success)`;

  const url = new URL(API + '/leaderboard');
  url.searchParams.set('period', period);
  url.searchParams.set('metric', metric);
  url.searchParams.set('size', size);
  url.searchParams.set('includeRecent','false');

  const r = await fetch(url);
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';

  if (!r.ok){
    document.getElementById('err').textContent = `Fel: ${r.status}`;
    return;
  }
  const data = await r.json();
  document.getElementById('err').textContent = '';

  let totalDeals = 0;
  (data.top||[]).forEach((row,i)=>{
    totalDeals += row.deals;
    const tr = document.createElement('tr');
    tr.innerHTML =
      `<td class="num">${i+1}</td>
       <td>${row.name}</td>
       <td style="opacity:.8">${row.group||'-'}</td>
       <td class="num">${num(row.deals)}</td>
       <td class="num">${num(row.commission)} THB</td>`;
    tb.appendChild(tr);
  });

  if (totalDeals > prevTotalDeals){
    pling(); confetti();
  }
  prevTotalDeals = totalDeals;
}

['period','metric','size'].forEach(id =>
  document.getElementById(id).addEventListener('change', load)
);
load();
setInterval(load, 15000);
</script>
</body>
</html>
